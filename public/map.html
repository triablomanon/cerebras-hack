<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoTrip Map</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }
        
        #map {
            width: 100%;
            height: 100vh;
            background-color: #e8f5e8;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-size: 18px;
            color: #059669;
        }
        
        .error {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            padding: 2rem;
            text-align: center;
            background-color: #fef2f2;
            color: #dc2626;
        }
        
        .error h2 {
            margin-bottom: 1rem;
        }
        
        .error p {
            margin-bottom: 1rem;
            color: #64748b;
        }
        
        .retry-btn {
            padding: 0.5rem 1rem;
            background: #059669;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .retry-btn:hover {
            background: #047857;
        }
    </style>
</head>
<body>
    <div id="map">
        <div class="loading">
            <i class="fas fa-map-marked-alt" style="margin-right: 10px;"></i>
            Loading EcoTrip Map...
        </div>
    </div>

    <script>
        let map;
        let markers = [];
        let bounds;
        
        // Initialize the map
        function initMap() {
            console.log('üó∫Ô∏è Initializing Google Maps...');
            
            try {
                // Create map centered on a default location (Paris)
                map = new google.maps.Map(document.getElementById('map'), {
                    center: { lat: 48.8566, lng: 2.3522 },
                    zoom: 10,
                    styles: [
                        {
                            featureType: 'poi',
                            elementType: 'labels',
                            stylers: [{ visibility: 'off' }]
                        }
                    ]
                });
                
                bounds = new google.maps.LatLngBounds();
                
                console.log('‚úÖ Google Maps initialized successfully!');
                
                // Add a test marker to verify the map is working
                const testMarker = new google.maps.Marker({
                    position: { lat: 48.8566, lng: 2.3522 },
                    map: map,
                    title: 'Test Location',
                    icon: {
                        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="12" cy="12" r="10" fill="#059669" stroke="white" stroke-width="2"/>
                                <circle cx="12" cy="12" r="4" fill="white"/>
                            </svg>
                        `),
                        scaledSize: new google.maps.Size(24, 24),
                        anchor: new google.maps.Point(12, 12)
                    }
                });
                
                markers.push(testMarker);
                bounds.extend(testMarker.getPosition());
                map.fitBounds(bounds);
                
                console.log('üìç Test marker added successfully!');
                
            } catch (error) {
                console.error('‚ùå Error initializing map:', error);
                showError('Failed to initialize Google Maps. Please check your API key.');
            }
        }
        
        function showError(message) {
            const mapDiv = document.getElementById('map');
            mapDiv.innerHTML = `
                <div class="error">
                    <h2><i class="fas fa-exclamation-triangle"></i> Map Error</h2>
                    <p>${message}</p>
                    <button class="retry-btn" onclick="location.reload()">
                        <i class="fas fa-redo"></i> Retry
                    </button>
                </div>
            `;
        }
        
        // Update markers when destinations change
        function updateMarkers(destinations) {
            console.log('üîÑ Updating markers with destinations:', destinations);
            
            if (!map || !destinations || destinations.length === 0) {
                console.log('‚ö†Ô∏è No destinations to display or map not ready');
                return;
            }
            
            try {
                // Clear existing markers
                markers.forEach(marker => marker.setMap(null));
                markers = [];
                bounds = new google.maps.LatLngBounds();
                
                console.log('üè∑Ô∏è Adding', destinations.length, 'markers to map');
                
                destinations.forEach((destination, index) => {
                    const position = {
                        lat: parseFloat(destination.latitude),
                        lng: parseFloat(destination.longitude)
                    };
                    
                    const marker = new google.maps.Marker({
                        position: position,
                        map: map,
                        title: destination.name,
                        label: {
                            text: (index + 1).toString(),
                            color: 'white',
                            fontWeight: 'bold'
                        },
                        icon: {
                            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                                <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="16" cy="16" r="14" fill="#059669" stroke="white" stroke-width="2"/>
                                    <text x="16" y="20" text-anchor="middle" fill="white" font-size="12" font-weight="bold">${index + 1}</text>
                                </svg>
                            `),
                            scaledSize: new google.maps.Size(32, 32),
                            anchor: new google.maps.Point(16, 16)
                        }
                    });
                    
                    // Add click listener
                    marker.addListener('click', () => {
                        console.log('üìç Marker clicked:', destination);
                        window.parent.postMessage({
                            type: 'marker-clicked',
                            destination: destination
                        }, '*');
                    });
                    
                    markers.push(marker);
                    bounds.extend(position);
                });
                
                // Fit map to show all markers
                if (markers.length > 0) {
                    map.fitBounds(bounds);
                    
                    // If only one marker, zoom in a bit
                    if (markers.length === 1) {
                        map.setZoom(12);
                    }
                }
                
                console.log('‚úÖ Markers updated successfully!');
                
            } catch (error) {
                console.error('‚ùå Error updating markers:', error);
            }
        }
        
        // Listen for messages from parent window
        window.addEventListener('message', function(event) {
            if (event.data.type === 'update-markers') {
                console.log('üì® Received update-markers message:', event.data.destinations);
                updateMarkers(event.data.destinations);
            }
        });
        
        // Initialize map when Google Maps API is loaded
        window.initMap = initMap;
        
        // Check if Google Maps API is already loaded
        if (typeof google !== 'undefined' && google.maps) {
            initMap();
        }
    </script>
    
    <!-- Google Maps API -->
    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAcVR9OmvDS9CPnH9eW8Oe5PgLp87wlItc&callback=initMap"
        async
        defer
    ></script>
</body>
</html>